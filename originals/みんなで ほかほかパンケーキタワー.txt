<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Åø„Çì„Å™„Åß „Åª„Åã„Åª„Åã„Éë„É≥„Ç±„Éº„Ç≠„Çø„ÉØ„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: none;
            overflow: hidden;
            background: #fff7ed;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
            user-select: none;
        }
        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: linear-gradient(to bottom, #ffedd5 0%, #fff7ed 100%);
        }
        .item {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        .pancake {
            background: #fbbf24;
            border: 3px solid #d97706;
            border-radius: 20px;
        }
        .strawberry {
            font-size: 3.5rem;
        }
        .chocolate {
            background: #451a03;
            border-radius: 10px;
            border: 2px solid #271105;
        }
        #plate {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 20px;
            background: #f1f5f9;
            border-bottom: 6px solid #94a3b8;
            border-radius: 40px;
            z-index: 5;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-fancy {
            background: #f43f5e;
            color: white;
            font-weight: 900;
            border-radius: 9999px;
            box-shadow: 0 8px 0 #be123c;
            transition: all 0.1s;
        }
        .btn-fancy:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .falling {
            transition: top 0.3s cubic-bezier(0.5, 0, 1, 0.5);
        }
        .success-anim {
            animation: bounce 0.2s ease-out;
        }
        .perfect-text {
            position: absolute;
            color: #f59e0b;
            font-weight: 900;
            font-size: 2rem;
            pointer-events: none;
            animation: fade-up 0.6s ease-out forwards;
            z-index: 100;
            text-shadow: 2px 2px 0 #fff;
        }
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes fade-up {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, -100px); opacity: 0; }
        }
        .input-field {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #fb923c;
            color: #431407;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 10px;
            font-size: 1.2rem;
            outline: none;
            text-align: center;
        }
        .rank-card {
            background: white;
            border: 2px solid #fb923c;
            border-radius: 20px;
            padding: 15px 25px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 320px;
        }
    </style>
</head>
<body class="m-0 p-0">

    <div id="game-container">
        <!-- 1. ‰∫∫Êï∞ÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="mode-screen" class="absolute inset-0 flex flex-col items-center justify-center z-[110] bg-orange-50 p-6 text-center">
            <h1 class="text-4xl font-black text-orange-600 mb-2">„Éë„É≥„Ç±„Éº„Ç≠„Çø„ÉØ„Éº</h1>
            <p class="text-orange-400 text-xl mb-8 font-bold">„Å™„Çì„Å´„Çì„Åß „ÅÇ„Åù„Å∂Ôºü</p>
            <div class="grid grid-cols-2 gap-4 w-full max-w-xs">
                <button onclick="selectPlayerCount(1)" class="btn-fancy py-6 text-3xl">1„Å´„Çì</button>
                <button onclick="selectPlayerCount(2)" class="btn-fancy py-6 text-3xl">2„Å´„Çì</button>
                <button onclick="selectPlayerCount(3)" class="btn-fancy py-6 text-3xl">3„Å´„Çì</button>
                <button onclick="selectPlayerCount(4)" class="btn-fancy py-6 text-3xl">4„Å´„Çì</button>
            </div>
        </div>

        <!-- 2. ÂêçÂâçÂÖ•ÂäõÁîªÈù¢ -->
        <div id="name-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center z-[110] bg-orange-50 p-6 text-center">
            <h2 class="text-3xl font-black text-orange-600 mb-6">„Å™„Åæ„Åà„Çí „ÅÑ„Çå„Å¶„Å≠</h2>
            <div id="name-inputs" class="w-full max-w-xs mb-8"></div>
            <button id="confirm-names-btn" class="btn-fancy py-4 px-12 text-2xl">„Åç„Åæ„ÇäÔºÅ</button>
        </div>

        <!-- 3. Ê∫ñÂÇôÁîªÈù¢ -->
        <div id="ready-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center z-[110] bg-orange-100/95 p-6 text-center">
            <h2 id="turn-title" class="text-4xl font-black text-orange-600 mb-4">„Å™„Åæ„Åà „ÅÆ „Å∞„Çì</h2>
            <div class="bg-white p-6 rounded-3xl border-4 border-orange-200 mb-10 shadow-lg">
                <p class="text-xl text-gray-700 font-bold leading-loose">
                    „ÅØ„Çì„Å∂„Çì‰ª•‰∏ä „ÅÆ„Åõ„Å™„ÅÑ„Å®<br>
                    „Åä„Å£„Åì„Å°„Å°„ÇÉ„ÅÜ„ÇàÔºÅ
                </p>
            </div>
            <button id="start-btn" class="btn-fancy py-8 px-20 text-4xl">„Çπ„Çø„Éº„ÉàÔºÅ</button>
        </div>

        <!-- „Ç≤„Éº„É†UI -->
        <div id="game-ui" class="hidden absolute top-0 left-0 w-full p-4 flex justify-between items-start z-50 pointer-events-none">
            <div class="bg-white/90 backdrop-blur-md rounded-2xl p-4 border-2 border-orange-200 shadow-lg">
                <p id="current-player-display" class="text-xs font-bold text-orange-400">„Å™„Åæ„Åà</p>
                <p class="text-3xl font-black text-orange-600"><span id="score-display">0</span></p>
            </div>
            <div class="bg-white/90 backdrop-blur-md rounded-2xl p-4 border-2 border-rose-200 shadow-lg">
                <p class="text-xs font-bold text-rose-400">„Å§„Åé</p>
                <div id="next-item-preview" class="text-4xl flex justify-center">ü•û</div>
            </div>
        </div>

        <!-- „ÅäÁöø -->
        <div id="plate"></div>

        <!-- „Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
        <div id="stack-area" class="absolute inset-0"></div>

        <!-- 4. „Çø„Éº„É≥„É™„Ç∂„É´„ÉàÁîªÈù¢ -->
        <div id="turn-result-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center z-[110] bg-orange-950/95 p-6 text-center">
            <h2 class="text-4xl font-black text-red-400 mb-4">„Åñ„Çì„Å≠„ÇìÔºÅ</h2>
            <div id="player-score-msg" class="text-white text-2xl mb-12">„Å™„Åæ„Åà „ÅØ 10Êûö „Å§„Çì„Å†ÔºÅ</div>
            <button id="next-player-btn" class="btn-fancy py-5 px-12 text-2xl">„Å§„Åé„ÅÆ „Å≤„Å®„Å∏</button>
        </div>

        <!-- 5. ÊúÄÁµÇ„É©„É≥„Ç≠„É≥„Ç∞ÁîªÈù¢ -->
        <div id="final-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center z-[110] bg-orange-50 p-6 text-center overflow-y-auto">
            <h1 class="text-4xl font-black text-orange-600 mb-8">üéâ „Åë„Å£„Åã„ÅØ„Å£„Å¥„Çá„ÅÜ</h1>
            <div id="ranking-list" class="flex flex-col items-center w-full mb-10"></div>
            <button id="restart-all-btn" class="bg-orange-600 text-white font-black py-4 px-10 rounded-full text-xl shadow-lg active:scale-95">
                „Åï„ÅÑ„Åó„Çá„Å´ „ÇÇ„Å©„Çã
            </button>
        </div>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const stackArea = document.getElementById('stack-area');
        const scoreDisplay = document.getElementById('score-display');
        const nextPreview = document.getElementById('next-item-preview');
        
        const modeScreen = document.getElementById('mode-screen');
        const nameScreen = document.getElementById('name-screen');
        const readyScreen = document.getElementById('ready-screen');
        const turnResultScreen = document.getElementById('turn-result-screen');
        const finalScreen = document.getElementById('final-screen');
        const gameUI = document.getElementById('game-ui');
        
        let playerCount = 1;
        let players = [];
        let currentPlayerIndex = 0;
        let gameActive = false;
        
        // „Ç≤„Éº„É†„Çπ„ÉÜ„Éº„Éà
        let score = 0;
        let currentItem = null;
        let stack = [];
        let speed = 4.0;
        let direction = 1;
        let nextType = 'pancake';

        const itemData = {
            pancake: { emoji: 'ü•û', width: 140, height: 35, class: 'pancake' },
            strawberry: { emoji: 'üçì', width: 70, height: 70, class: 'strawberry' },
            chocolate: { emoji: 'üç´', width: 120, height: 20, class: 'chocolate' }
        };

        // ‰∫∫Êï∞ÈÅ∏Êäû
        function selectPlayerCount(count) {
            playerCount = count;
            modeScreen.classList.add('hidden');
            nameScreen.classList.remove('hidden');
            const nameInputs = document.getElementById('name-inputs');
            nameInputs.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'input-field';
                input.placeholder = `${i}„Å´„Çì„ÇÅ„ÅÆ „Å™„Åæ„Åà`;
                input.value = `„Éó„É¨„Ç§„É§„Éº${i}`;
                input.id = `p${i}-name`;
                nameInputs.appendChild(input);
            }
        }

        // ÂêçÂâçÁ¢∫ÂÆö
        document.getElementById('confirm-names-btn').onclick = () => {
            players = [];
            for (let i = 1; i <= playerCount; i++) {
                const name = document.getElementById(`p${i}-name`).value || `${i}„Å´„Çì„ÇÅ`;
                players.push({ name: name, score: 0 });
            }
            currentPlayerIndex = 0;
            nameScreen.classList.add('hidden');
            showReadyScreen();
        };

        function showReadyScreen() {
            turnResultScreen.classList.add('hidden');
            readyScreen.classList.remove('hidden');
            document.getElementById('turn-title').textContent = `${players[currentPlayerIndex].name} „ÅÆ „Å∞„Çì`;
        }

        document.getElementById('start-btn').onclick = () => {
            readyScreen.classList.add('hidden');
            gameUI.classList.remove('hidden');
            document.getElementById('current-player-display').textContent = players[currentPlayerIndex].name;
            initGame();
        };

        function initGame() {
            score = 0;
            speed = 4.0;
            stack = [{ x: (window.innerWidth - 180) / 2, width: 180, y: window.innerHeight - 60, type: 'plate' }];
            stackArea.innerHTML = '';
            scoreDisplay.textContent = '0';
            nextType = 'pancake';
            updatePreview();
            
            // „Éó„É¨„Éº„Éà„ÅÆ‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('plate').style.bottom = '60px';
            gameActive = true;
            spawnItem();
        }

        function updatePreview() {
            const types = ['pancake', 'pancake', 'strawberry', 'chocolate'];
            nextType = types[Math.floor(Math.random() * types.length)];
            nextPreview.textContent = itemData[nextType].emoji;
        }

        function spawnItem() {
            if (!gameActive) return;
            const data = itemData[nextType];
            const el = document.createElement('div');
            el.className = `item ${data.class}`;
            el.style.width = data.width + 'px';
            el.style.height = data.height + 'px';
            el.style.top = '140px'; 
            el.textContent = data.emoji;
            
            const startX = Math.random() * (window.innerWidth - data.width);
            direction = Math.random() > 0.5 ? 1 : -1;
            
            currentItem = { 
                el, 
                x: startX, 
                y: 140, 
                width: data.width, 
                height: data.height, 
                type: nextType, 
                falling: false 
            };
            
            // ÂàùÊúü‰ΩçÁΩÆ„ÇíÂèçÊò†
            el.style.left = startX + 'px';
            stackArea.appendChild(el);
            updatePreview();
        }

        // Â∏∏„Å´ÂÆüË°å„Åï„Çå„Çã„Ç≤„Éº„É†„É´„Éº„Éó
        function gameLoop() {
            if (gameActive && currentItem && !currentItem.falling) {
                currentItem.x += speed * direction;
                const rightEdge = window.innerWidth - currentItem.width;
                if (currentItem.x >= rightEdge) { 
                    currentItem.x = rightEdge; 
                    direction = -1; 
                } else if (currentItem.x <= 0) { 
                    currentItem.x = 0; 
                    direction = 1; 
                }
                currentItem.el.style.left = currentItem.x + 'px';
            }
            requestAnimationFrame(gameLoop);
        }

        function drop() {
            if (!gameActive || !currentItem || currentItem.falling) return;
            currentItem.falling = true;
            const targetY = stack[stack.length - 1].y - currentItem.height;
            currentItem.el.classList.add('falling');
            currentItem.el.style.top = targetY + 'px';
            setTimeout(() => { checkLanding(targetY); }, 300);
        }

        function checkLanding(targetY) {
            if (!gameActive) return;
            const last = stack[stack.length - 1];
            const overlap = Math.min(currentItem.x + currentItem.width, last.x + last.width) - Math.max(currentItem.x, last.x);
            const overlapRatio = overlap / currentItem.width;

            if (overlapRatio > 0.6) {
                score++;
                scoreDisplay.textContent = score;
                currentItem.el.classList.add('success-anim');
                if (overlapRatio > 0.95) showPerfectEffect(currentItem.x + currentItem.width / 2, targetY);
                stack.push({ x: currentItem.x, width: currentItem.width, y: targetY, type: currentItem.type });
                speed = Math.min(speed + 0.3, 12.0);
                if (targetY < window.innerHeight * 0.45) moveStackDown();
                spawnItem();
            } else {
                currentItem.el.style.top = '110vh';
                currentItem.el.style.transition = 'top 0.6s ease-in';
                gameOver();
            }
        }

        function showPerfectEffect(x, y) {
            const text = document.createElement('div');
            text.className = 'perfect-text';
            text.style.left = x + 'px'; text.style.top = y + 'px';
            text.textContent = '„Å¥„Å£„Åü„ÇäÔºÅ';
            stackArea.appendChild(text);
            setTimeout(() => text.remove(), 600);
        }

        function moveStackDown() {
            const offset = 100;
            const items = document.querySelectorAll('.item');
            items.forEach(el => { const t = parseInt(el.style.top); el.style.top = (t + offset) + 'px'; });
            stack.forEach(s => s.y += offset);
            const plate = document.getElementById('plate');
            const pb = parseInt(window.getComputedStyle(plate).bottom);
            plate.style.bottom = (pb - offset) + 'px';
        }

        function gameOver() {
            gameActive = false;
            players[currentPlayerIndex].score = score;
            setTimeout(() => {
                gameUI.classList.add('hidden');
                turnResultScreen.classList.remove('hidden');
                document.getElementById('player-score-msg').textContent = `${players[currentPlayerIndex].name} „ÅØ ${score}Êûö „Å§„Çì„Å†ÔºÅ`;
            }, 700);
        }

        document.getElementById('next-player-btn').onclick = () => {
            currentPlayerIndex++;
            if (currentPlayerIndex < playerCount) {
                showReadyScreen();
            } else {
                showFinalRanking();
            }
        };

        function showFinalRanking() {
            turnResultScreen.classList.add('hidden');
            finalScreen.classList.remove('hidden');
            const sorted = [...players].sort((a, b) => b.score - a.score);
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';
            const medals = ['ü•á', 'ü•à', 'ü•â', '‚ú®'];
            sorted.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'rank-card shadow-md';
                div.innerHTML = `
                    <span class="text-xl font-bold text-orange-600">${medals[i] || '‚ú®'} ${p.name}</span>
                    <span class="text-2xl font-black text-orange-600">${p.score}Êûö</span>
                `;
                list.appendChild(div);
            });
        }

        document.getElementById('restart-all-btn').onclick = () => {
            finalScreen.classList.add('hidden');
            modeScreen.classList.remove('hidden');
        };

        window.addEventListener('mousedown', drop);
        window.addEventListener('touchstart', (e) => {
            if (e.target.tagName !== 'BUTTON') { e.preventDefault(); drop(); }
        }, { passive: false });

        // „É´„Éº„Éó„ÇíÈñãÂßã
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>