<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="./../manifest.json">
    <link rel="apple-touch-icon" href="./../assets/icons/apple-touch-icon.png">
    <title>„Åó„ÇÉ„Åº„ÇìÁéâ„ÅΩ„Çì„ÅΩ„Çì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: manipulation;
            overflow: hidden;
            background: linear-gradient(to bottom, #e0f2fe, #bae6fd);
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.1));
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            animation: float-up linear forwards;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            pointer-events: auto;
        }

        @keyframes float-up {
            from {
                transform: translateY(110vh);
            }

            to {
                transform: translateY(-20vh);
            }
        }

        .pop {
            animation: pop-effect 0.2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes pop-effect {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .score-anim {
            animation: bounce 0.3s ease;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }
        }

        .btn-fancy {
            background: #f472b6;
            color: white;
            font-weight: 900;
            border-radius: 9999px;
            box-shadow: 0 4px 0 #be185d;
            transition: all 0.1s;
        }

        .btn-fancy:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .input-field {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #3b82f6;
            color: #1e3a8a;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 12px;
            font-size: 1.2rem;
            outline: none;
        }

        .rank-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 15px 25px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 320px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
    </style>
</head>

<body class="h-screen w-screen m-0 p-0">

    <!-- Base UI (Container for overlap) -->
    <div id="game-container" class="relative w-full h-full overflow-hidden">

        <!-- Global Back Button (iPhone Optimized) -->
        <div id="global-back-ui"
            class="fixed top-0 left-0 w-full z-[110] px-4 pt-[calc(env(safe-area-inset-top)+10px)] pointer-events-none">
            <div class="max-w-lg mx-auto flex justify-start">
                <a href="./../index.html"
                    class="bg-white/40 backdrop-blur-md p-2 rounded-xl border border-white/30 shadow-lg pointer-events-auto active:scale-95 transition-all text-xl">üè†</a>
            </div>
        </div>

        <!-- Re-styled Header (iPhone Optimized - Game Only Info) -->
        <div id="game-ui"
            class="hidden fixed top-0 left-0 w-full z-[100] px-4 pt-[calc(env(safe-area-inset-top)+10px)] pointer-events-none">
            <div class="flex items-center justify-end w-full max-w-lg mx-auto pointer-events-none">
                <div
                    class="flex items-center gap-3 bg-white/40 backdrop-blur-md rounded-2xl p-2 border border-white/30 shadow-lg pointer-events-auto">
                    <div class="flex flex-col items-center px-3 border-r border-blue-200/50">
                        <span id="current-player-display"
                            class="text-[10px] font-bold text-blue-600 truncate max-w-[60px]">PLAYER</span>
                        <span id="timer-display" class="text-xl font-black text-blue-600 leading-none">30</span>
                    </div>
                    <div class="flex flex-col items-center px-3">
                        <span class="text-[10px] font-bold text-pink-600">SCORE</span>
                        <span id="score-display" class="text-xl font-black text-pink-500 leading-none">0</span>
                    </div>
                </div>

                <div id="bonus-toast"
                    class="opacity-0 absolute right-4 top-full mt-2 transition-all duration-300 transform translate-y-2 pointer-events-none bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-lg">
                    +1s</div>
            </div>
        </div>
        <!-- 1. Select Number of Players -->
        <div id="mode-screen"
            class="absolute inset-0 flex flex-col items-center justify-center z-50 bg-white bg-opacity-80 p-6 text-center">
            <h1 class="text-4xl font-bold text-blue-600 mb-8">„Åó„ÇÉ„Åº„ÇìÁéâ„ÅΩ„Çì„ÅΩ„Çì</h1>
            <p class="text-gray-700 text-xl mb-8">„Å™„Çì„Å´‰∫∫„Åß „ÅÇ„Åù„Å∂Ôºü</p>
            <div class="grid grid-cols-2 gap-4 w-full max-w-xs">
                <button onclick="selectPlayerCount(1)" class="btn-fancy py-6 text-3xl">1„Å´„Çì</button>
                <button onclick="selectPlayerCount(2)" class="btn-fancy py-6 text-3xl">2„Å´„Çì</button>
                <button onclick="selectPlayerCount(3)" class="btn-fancy py-6 text-3xl">3„Å´„Çì</button>
                <button onclick="selectPlayerCount(4)" class="btn-fancy py-6 text-3xl">4„Å´„Çì</button>
            </div>
        </div>

        <!-- 2. Name Entry Screen -->
        <div id="name-screen"
            class="hidden absolute inset-0 flex flex-col items-center justify-center z-50 bg-white bg-opacity-90 p-6 text-center overflow-y-auto">
            <h2 class="text-3xl font-bold text-blue-600 mb-6">„Å™„Åæ„Åà„Çí „ÅÑ„Çå„Å¶„Å≠</h2>
            <div id="name-inputs" class="w-full max-w-xs mb-8">
                <!-- Dynamic Inputs -->
            </div>
            <button id="confirm-names-btn" class="btn-fancy py-4 px-12 text-2xl">„Åç„Åæ„ÇäÔºÅ</button>
        </div>

        <!-- 3. Ready Screen -->
        <div id="ready-screen"
            class="hidden absolute inset-0 flex flex-col items-center justify-center z-50 bg-blue-50 bg-opacity-95 p-6 text-center">
            <h2 id="turn-title" class="text-4xl font-bold text-blue-600 mb-4">„Å™„Åæ„Åà „ÅÆ „Å∞„Çì</h1>
                <p class="text-gray-700 text-xl mb-12">„Åò„ÇÖ„Çì„Å≥„ÅØ „ÅÑ„ÅÑ„Åã„Å™Ôºü</p>
                <button id="start-btn"
                    class="btn-fancy py-8 px-20 text-4xl bg-pink-500 hover:bg-pink-600 text-white shadow-xl">„Çπ„Çø„Éº„ÉàÔºÅ</button>
        </div>

        <!-- Big Time Over Message -->
        <div id="time-over-overlay"
            class="hidden absolute inset-0 flex items-center justify-center z-[200] pointer-events-none">
            <h2
                class="text-6xl font-black text-pink-500 italic drop-shadow-[0_5px_15px_rgba(0,0,0,0.2)] transform -rotate-12 scale-150 animate-bounce">
                „Åò„Åã„Çì„Åé„ÇåÔºÅ</h2>
        </div>

        <!-- 5. Turn Result Screen -->
        <div id="turn-result-screen"
            class="hidden absolute inset-0 flex flex-col items-center justify-center z-50 bg-white bg-opacity-95 p-6 text-center">
            <h2 class="text-4xl font-bold text-blue-600 mb-4">„Åä„Åó„Åæ„ÅÑÔºÅ</h2>
            <div id="player-score-msg" class="text-gray-700 text-2xl mb-12">„Å™„Åæ„Åà „ÅØ 30„Å¶„Çì „Å®„Çå„Åü„ÇàÔºÅ</div>
            <button id="next-player-btn" class="btn-fancy py-5 px-12 text-2xl bg-blue-500">„Å§„Åé„Å∏ „Åô„Åô„ÇÄ</button>
        </div>

        <!-- 6. Final Leaderboard -->
        <div id="final-screen"
            class="hidden absolute inset-0 flex flex-col items-center justify-center z-50 bg-white p-6 text-center">
            <h1 class="text-4xl font-bold text-blue-600 mb-8">üéâ „Åë„Å£„Åã„ÅØ„Å£„Å¥„Çá„ÅÜ</h1>
            <div id="ranking-list" class="flex flex-col items-center w-full mb-10"></div>
            <button id="restart-btn" class="btn-fancy bg-blue-500 py-4 px-10 text-xl">„Åï„ÅÑ„Åó„Çá„Å´ „ÇÇ„Å©„Çã</button>
        </div>
    </div>

    <script>
        const gameContainer = document.getElementById('game-container');
        const scoreDisplay = document.getElementById('score-display');
        const timerDisplay = document.getElementById('timer-display');

        const modeScreen = document.getElementById('mode-screen');
        const nameScreen = document.getElementById('name-screen');
        const readyScreen = document.getElementById('ready-screen');
        const turnResultScreen = document.getElementById('turn-result-screen');
        const finalScreen = document.getElementById('final-screen');
        const gameUI = document.getElementById('game-ui');

        let playerCount = 1;
        let players = [];
        let currentPlayerIndex = 0;
        let score = 0;
        let timeLeft = 30;
        let gameActive = false;
        let spawnInterval;
        let timerInterval;

        const emojis = ['ü´ß', 'ü´ß', 'ü´ß', '‚ú®', 'üéà', 'üåü'];

        // 1. Select Player Count
        function selectPlayerCount(count) {
            playerCount = count;
            modeScreen.classList.add('hidden');
            nameScreen.classList.remove('hidden');

            const nameInputs = document.getElementById('name-inputs');
            nameInputs.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'input-field';
                input.placeholder = `${i}„Å´„Çì„ÇÅ„ÅÆ „Å™„Åæ„Åà`;
                input.value = `„Éó„É¨„Ç§„É§„Éº${i}`;
                input.id = `p${i}-name`;
                nameInputs.appendChild(input);
            }
        }

        // 2. Confirm Names
        document.getElementById('confirm-names-btn').onclick = () => {
            players = [];
            for (let i = 1; i <= playerCount; i++) {
                const name = document.getElementById(`p${i}-name`).value || `${i}„Å´„Çì„ÇÅ`;
                players.push({ name: name, score: 0 });
            }
            currentPlayerIndex = 0;
            nameScreen.classList.add('hidden');
            showReadyScreen();
        };

        function showReadyScreen() {
            turnResultScreen.classList.add('hidden');
            readyScreen.classList.remove('hidden');
            document.getElementById('turn-title').textContent = `${players[currentPlayerIndex].name} „ÅÆ „Å∞„Çì`;
        }

        // 3. Start Game
        document.getElementById('start-btn').onclick = () => {
            score = 0;
            timeLeft = 30;
            scoreDisplay.textContent = score;
            timerDisplay.textContent = timeLeft;
            document.getElementById('current-player-display').textContent = players[currentPlayerIndex].name;
            document.getElementById('time-over-overlay').classList.add('hidden');

            readyScreen.classList.add('hidden');
            gameUI.classList.remove('hidden');
            gameActive = true;

            const existingBubbles = gameContainer.querySelectorAll('.bubble');
            existingBubbles.forEach(b => b.remove());

            // Spawn bubbles
            spawnInterval = setInterval(() => {
                if (gameActive) createBubble();
            }, 550);

            // Timer
            timerInterval = setInterval(() => {
                if (!gameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                timeLeft--;
                timerDisplay.textContent = Math.max(0, timeLeft);

                if (timeLeft <= 5) {
                    timerDisplay.classList.add('text-red-500', 'animate-pulse');
                } else {
                    timerDisplay.classList.remove('text-red-500', 'animate-pulse');
                }

                if (timeLeft <= 0) {
                    showTimeOver();
                }
            }, 1000);
        };

        function showTimeOver() {
            gameActive = false;
            document.getElementById('time-over-overlay').classList.remove('hidden');
            if (window.navigator.vibrate) window.navigator.vibrate([100, 50, 100]);

            setTimeout(() => {
                endGame();
            }, 1500);
        }

        function createBubble() {
            const bubble = document.createElement('div');
            const size = Math.floor(Math.random() * 40) + 70;
            const xPos = Math.random() * (window.innerWidth - size);
            const duration = Math.random() * 2 + 3;
            const colorIndex = Math.floor(Math.random() * 360);

            bubble.className = 'bubble';
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;
            bubble.style.left = `${xPos}px`;
            bubble.style.animationDuration = `${duration}s`;
            bubble.style.borderColor = `hsla(${colorIndex}, 70%, 70%, 0.6)`;

            const isBonus = Math.random() > 0.7;
            if (isBonus) {
                bubble.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                bubble.dataset.bonus = "true";
            }

            const popHandler = (e) => {
                e.preventDefault();
                if (!gameActive) return;
                popBubble(bubble);
            };

            bubble.addEventListener('mousedown', popHandler);
            bubble.addEventListener('touchstart', popHandler);

            bubble.addEventListener('animationend', (e) => {
                if (e.animationName === 'float-up') {
                    if (bubble.parentNode) bubble.parentNode.removeChild(bubble);
                }
            });

            gameContainer.appendChild(bubble);
        }

        function popBubble(element) {
            if (element.dataset.popped) return;
            element.dataset.popped = "true";

            const bonusItem = element.dataset.bonus === "true";

            // Instant visual kill
            element.style.display = 'none';
            element.style.visibility = 'hidden';
            element.style.opacity = '0';

            score++;
            if (bonusItem) {
                timeLeft += 1;
                showBonusToast();
            }

            scoreDisplay.textContent = score;
            scoreDisplay.parentElement.classList.remove('score-anim');
            void scoreDisplay.parentElement.offsetWidth;
            scoreDisplay.parentElement.classList.add('score-anim');

            if (window.navigator.vibrate) try { window.navigator.vibrate(10); } catch (e) { }

            if (element.parentNode) {
                element.parentNode.removeChild(element);
            }
        }

        function showBonusToast() {
            const toast = document.getElementById('bonus-toast');
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 600);
        }

        function endGame() {
            gameActive = false;
            clearInterval(spawnInterval);
            clearInterval(timerInterval);
            gameUI.classList.add('hidden');

            players[currentPlayerIndex].score = score;

            turnResultScreen.classList.remove('hidden');
            document.getElementById('player-score-msg').textContent = `${players[currentPlayerIndex].name} „ÅØ ${score}„Å¶„Çì „Å®„Çå„Åü„ÇàÔºÅ`;
        }

        document.getElementById('next-player-btn').onclick = () => {
            currentPlayerIndex++;
            if (currentPlayerIndex < playerCount) {
                showReadyScreen();
            } else {
                showFinalRanking();
            }
        };

        function showFinalRanking() {
            turnResultScreen.classList.add('hidden');
            finalScreen.classList.remove('hidden');

            const sorted = [...players].sort((a, b) => b.score - a.score);
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';

            const medals = ['ü•á', 'ü•à', 'ü•â', '‚ú®'];
            sorted.forEach((p, i) => {
                const row = document.createElement('div');
                row.className = 'rank-card';
                row.innerHTML = `
                    <span class="text-xl font-bold text-blue-600">${medals[i] || '‚ú®'} ${p.name}</span>
                    <span class="text-xl font-black text-pink-500">${p.score}„Å¶„Çì</span>
                `;
                list.appendChild(row);
            });
        }

        document.getElementById('restart-btn').onclick = () => {
            finalScreen.classList.add('hidden');
            modeScreen.classList.remove('hidden');
        };

        document.addEventListener('touchmove', (e) => {
            if (gameActive) e.preventDefault();
        }, { passive: false });
    </script>
</body>

</html>