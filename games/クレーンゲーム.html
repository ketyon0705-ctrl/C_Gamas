<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="./../manifest.json">
    <link rel="apple-touch-icon" href="./../assets/icons/apple-touch-icon.png">
    <title>„ÇØ„É¨„Éº„É≥„Ç≤„Éº„É†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: none;
            overflow: hidden;
            background: linear-gradient(to bottom, #1e3a8a 0%, #3b82f6 100%);
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
            user-select: none;
        }

        canvas {
            background: rgba(0, 0, 0, 0.2);
            border: 6px solid #fbbf24;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
            display: block;
            touch-action: none;
            width: 90%;
            max-width: 500px;
            aspect-ratio: 1 / 1;
        }

        #crane-wire {
            position: absolute;
            top: 0;
            width: 4px;
            background: #4b5563;
            transition: height 0.5s ease-in-out;
            z-index: 10;
        }

        #arm-left,
        #arm-right {
            position: absolute;
            width: 40px;
            height: 60px;
            background: #9ca3af;
            border-radius: 20px;
            transition: transform 0.3s;
            z-index: 11;
        }

        .gem {
            position: absolute;
            font-size: 3rem;
            cursor: pointer;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            transition: transform 0.2s;
        }

        .win-anim {
            animation: win-float 1s ease-out forwards;
        }

        @keyframes win-float {
            0% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }

            100% {
                transform: scale(2) translateY(-100px);
                opacity: 0;
            }
        }

        .btn-fancy {
            background: #ef4444;
            color: white;
            font-weight: 900;
            border-radius: 9999px;
            box-shadow: 0 4px 0 #991b1b;
            transition: all 0.1s;
            touch-action: manipulation;
            pointer-events: auto;
        }

        .btn-fancy:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .input-field {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ef4444;
            color: #7f1d1d;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 12px;
            font-size: 1.2rem;
            outline: none;
        }

        .rank-card {
            background: rgba(30, 27, 75, 0.8);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            padding: 12px 20px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body class="h-screen w-screen m-0 p-0 overflow-hidden flex flex-col bg-indigo-900 text-white">


    <!-- 1. Top Safe Area (50px for Notch) -->
    <div id="safe-area-top" class="h-[50px] w-full shrink-0"></div>

    <!-- 2. Header UI (Immediately below safe area) -->
    <div id="game-header" class="hidden h-[60px] w-full shrink-0 flex items-center justify-between px-6 z-[60]">
        <a href="./../index.html"
            class="bg-white/10 hover:bg-white/20 text-white font-bold py-2.5 px-6 rounded-2xl border border-white/20 backdrop-blur-sm transition-transform active:scale-95 flex items-center gap-2">
            <span class="text-xl">üè†</span> „ÇÇ„Å©„Çã
        </a>

        <div class="flex items-center gap-6">
            <div class="text-right">
                <p class="text-[10px] text-red-300 font-bold uppercase tracking-wider">„Åò„Åã„Çì</p>
                <p id="timer-display" class="text-3xl font-black italic">30</p>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-yellow-300 font-bold uppercase tracking-wider">„Çπ„Ç≥„Ç¢</p>
                <p id="score-display" class="text-3xl font-black italic">0</p>
            </div>
        </div>
    </div>

    <!-- 3. Central Game Area (Maximized) -->
    <div id="game-container"
        class="relative flex-grow w-full flex flex-col items-center justify-center p-2 pt-0 min-h-0">

        <!-- Player Info Overlay (Inside/Above Canvas) -->
        <div id="player-info-badge" class="hidden absolute top-0 left-1/2 -translate-x-1/2 z-[70] translate-y-2">
            <div
                class="bg-indigo-950/80 backdrop-blur-md px-5 py-2 rounded-full border border-white/20 shadow-xl flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-lg">üë§</span>
                    <span id="current-player-display" class="font-bold text-sm tracking-tight">„Å™„Åæ„Åà</span>
                </div>
                <div class="h-4 w-[1px] bg-white/20"></div>
                <div class="flex items-center gap-2">
                    <span class="text-lg text-yellow-400">‚òÖ</span>
                    <span class="text-xs text-white/60">Lv.</span>
                    <span id="level-display" class="font-black">1</span>
                </div>
            </div>
        </div>

        <canvas id="game-canvas" class="object-contain shadow-[0_0_50px_rgba(0,0,0,0.5)]"></canvas>

        <!-- Overlay screens -->
        <!-- 1. Select Number of Players -->
        <div id="mode-screen"
            class="absolute inset-0 flex flex-col items-center justify-center z-[100] bg-indigo-950 p-6 text-center">
            <h1
                class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-red-500 mb-12">
                „ÇØ„É¨„Éº„É≥„Ç≤„Éº„É†</h1>
            <p class="text-white/80 text-xl mb-10 font-bold">„Å™„Çì„Å´„Çì„Åß „ÅÇ„Åù„Å∂Ôºü</p>
            <div class="grid grid-cols-2 gap-4 w-full max-w-xs">
                <button onclick="selectPlayerCount(1)" class="btn-fancy py-6 text-3xl">1„Å´„Çì</button>
                <button onclick="selectPlayerCount(2)" class="btn-fancy py-6 text-3xl">2„Å´„Çì</button>
                <button onclick="selectPlayerCount(3)" class="btn-fancy py-6 text-3xl">3„Å´„Çì</button>
                <button onclick="selectPlayerCount(4)" class="btn-fancy py-6 text-3xl">4„Å´„Çì</button>
            </div>
        </div>

        <!-- 2. Name Entry Screen -->
        <div id="name-screen"
            class="hidden absolute inset-0 flex flex-col items-center justify-center z-[100] bg-indigo-900 p-6 text-center">
            <h2 class="text-3xl font-bold text-yellow-400 mb-8">„Å™„Åæ„Åà„Çí „ÅÑ„Çå„Å¶„Å≠</h2>
            <div id="name-inputs" class="w-full max-w-xs mb-8"></div>
            <button id="confirm-names-btn" class="btn-fancy py-4 px-12 text-2xl bg-yellow-500">„Åç„Åæ„ÇäÔºÅ</button>
        </div>

        <!-- 3. Ready Screen -->
        <div id="ready-screen"
            class="hidden absolute inset-0 flex flex-col items-center justify-center z-[100] bg-indigo-950/95 p-6 text-center">
            <h2 id="turn-title" class="text-5xl font-black text-white mb-6 uppercase tracking-tighter">„Å™„Åæ„Åà „ÅÆ „Å∞„Çì</h1>
                <p class="text-white/60 text-xl mb-12 font-medium">„Åò„ÇÖ„Çì„Å≥„ÅØ „ÅÑ„ÅÑ„Åã„Å™Ôºü</p>
                <button id="start-btn" class="btn-fancy py-8 px-20 text-4xl bg-red-500 shadow-red-900/50">„Çπ„Çø„Éº„ÉàÔºÅ</button>
        </div>

        <!-- 4. Turn Result Screen -->
        <div id="turn-result-screen"
            class="hidden absolute inset-0 flex flex-col items-center justify-center z-[110] bg-black/90 p-6 text-center backdrop-blur-lg">
            <h2 class="text-5xl font-black text-red-500 mb-6 italic">TIME UP!</h2>
            <div id="player-score-msg" class="text-white text-3xl mb-12 font-bold"></div>
            <button id="next-player-btn" class="btn-fancy py-5 px-16 text-2xl bg-indigo-500">„Å§„Åé„Å∏</button>
        </div>

        <!-- 5. Final Leaderboard -->
        <div id="final-screen"
            class="hidden absolute inset-0 flex flex-col items-center justify-center z-[120] bg-indigo-950 p-6 text-center">
            <h1 class="text-5xl font-black text-yellow-400 mb-10">RESULT</h1>
            <div id="ranking-list" class="flex flex-col items-center w-full mb-10 gap-2"></div>
            <button id="restart-btn" class="btn-fancy bg-red-500 py-5 px-12 text-2xl">„ÇÇ„ÅÜ„ÅÑ„Å°„Å© „ÅÇ„Åù„Å∂</button>
        </div>
    </div>

    <!-- 4. Bottom Controls Area -->
    <div id="controls-panel"
        class="hidden h-[160px] w-full shrink-0 flex justify-center items-center gap-6 bg-black/20 backdrop-blur-md px-6 pb-4 relative z-[60] pointer-events-auto border-t border-white/5">
        <button id="btn-left" class="btn-fancy w-24 h-24 text-3xl bg-indigo-600 shadow-indigo-900/50">‚óÄ</button>
        <button id="btn-drop" class="btn-fancy w-44 h-24 text-3xl bg-red-500 shadow-red-900/50">„Åó„Åü„Å∏ÔºÅ</button>
        <button id="btn-right" class="btn-fancy w-24 h-24 text-3xl bg-indigo-600 shadow-indigo-900/50">‚ñ∂</button>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score-display');
        const timerDisplay = document.getElementById('timer-display');
        const levelDisplay = document.getElementById('level-display');
        const modeScreen = document.getElementById('mode-screen');
        const nameScreen = document.getElementById('name-screen');
        const readyScreen = document.getElementById('ready-screen');
        const turnResultScreen = document.getElementById('turn-result-screen');
        const finalScreen = document.getElementById('final-screen');
        const gameUI = document.getElementById('game-header');
        const playerInfoBadge = document.getElementById('player-info-badge');
        const gameContainer = document.getElementById('game-container');

        let playerCount = 1;
        let players = [];
        let currentPlayerIndex = 0;
        let score = 0;
        let gameActive = false;

        // Original Game Logic Variables
        let level = 1;
        let timeLeft = 30;
        let timerInterval;
        let state = 'idle'; // idle, dropping, lifting, caught
        let craneX = 0;
        let craneY = 50;
        let craneSpeed = 6;
        let dropSpeed = 5;
        let liftSpeed = 4;
        let clawOpen = true;

        const gem = { x: 0, y: 0, size: 45, speed: 2, direction: 1 };
        const obstacles = [];
        const particles = [];
        const floatingMessages = [];

        function createParticles(x, y, color, count = 10) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 1.0,
                    color: color || '#fff'
                });
            }
        }

        function createFloatingMessage(x, y, text, color = '#fff') {
            floatingMessages.push({
                x, y,
                text,
                color,
                life: 1.0,
                vy: -2
            });
        }

        function resizeCanvas() {
            // Priority 1: Full width (minus small margin)
            const availableWidth = window.innerWidth - 20;

            // Priority 2: Fits between header and controls
            const container = document.getElementById('game-container');
            const availableHeight = container ? container.clientHeight - 40 : window.innerHeight * 0.6;

            // Result size (‰øùÊåÅ aspect ratio 1:1)
            const size = Math.min(availableWidth, availableHeight);

            canvas.width = size;
            canvas.height = size;
            craneX = canvas.width / 2;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function initLevel() {
            gem.x = canvas.width / 2;
            gem.y = canvas.height - 60;
            gem.speed = 2 + (level * 0.5);

            obstacles.length = 0;
            const count = 5;
            const speedMultiplier = Math.pow(1.2, level - 1);
            for (let i = 0; i < count; i++) {
                obstacles.push({
                    x: Math.random() * (canvas.width - 80),
                    y: 100 + i * ((canvas.height - 220) / count),
                    width: 70,
                    height: 50,
                    speed: (2 + Math.random() * 2) * (i % 2 === 0 ? 1 : -1) * speedMultiplier,
                    emoji: '‚òÅÔ∏è'
                });
            }
            levelDisplay.textContent = level;
        }

        // 1. Select Player Count
        function selectPlayerCount(count) {
            playerCount = count;
            modeScreen.classList.add('hidden');
            nameScreen.classList.remove('hidden');
            const nameInputs = document.getElementById('name-inputs');
            nameInputs.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const input = document.createElement('input');
                input.className = 'input-field';
                input.placeholder = `${i}„Å´„Çì„ÇÅ„ÅÆ „Å™„Åæ„Åà`;
                input.value = `„Éó„É¨„Ç§„É§„Éº${i}`;
                input.id = `p${i}-name`;
                nameInputs.appendChild(input);
            }
        }

        document.getElementById('confirm-names-btn').onclick = () => {
            players = [];
            for (let i = 1; i <= playerCount; i++) {
                const name = document.getElementById(`p${i}-name`).value || `${i}„Å´„Çì„ÇÅ`;
                players.push({ name: name, score: 0 });
            }
            currentPlayerIndex = 0;
            nameScreen.classList.add('hidden');
            showReadyScreen();
        };

        function showReadyScreen() {
            turnResultScreen.classList.add('hidden');
            readyScreen.classList.remove('hidden');
            document.getElementById('turn-title').textContent = `${players[currentPlayerIndex].name} „ÅÆ „Å∞„Çì`;
        }

        // 3. Start Game
        document.getElementById('start-btn').onclick = () => {
            score = 0;
            level = 1;
            scoreDisplay.textContent = score;
            document.getElementById('current-player-display').textContent = players[currentPlayerIndex].name;
            readyScreen.classList.add('hidden');
            gameUI.classList.remove('hidden');
            playerInfoBadge.classList.remove('hidden');
            document.getElementById('controls-panel').classList.remove('hidden');

            startTurn();
        };

        function startTurn() {
            state = 'idle';
            craneY = 50;
            craneX = canvas.width / 2;
            clawOpen = true;
            initLevel();
            if (!timerInterval) {
                timeLeft = 30; // Initial time
                startTimer();
            }
            gameActive = true;
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerDisplay.textContent = timeLeft;
            timerDisplay.classList.remove('text-red-500');

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 5) {
                    timerDisplay.classList.add('text-red-500');
                    timerDisplay.classList.add('scale-110');
                    setTimeout(() => timerDisplay.classList.remove('scale-110'), 200);
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    endGame("„Åò„Åã„Çì„Åé„ÇåÔºÅ");
                }
            }, 1000);
        }

        // Controls Setup
        let moveLeft = false;
        let moveRight = false;
        const setupBtn = (id, start, end) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); start(); });
            el.addEventListener('touchend', end);
            el.addEventListener('mousedown', start);
            el.addEventListener('mouseup', end);
            el.addEventListener('mouseleave', end);
        };

        setupBtn('btn-left', () => moveLeft = true, () => moveLeft = false);
        setupBtn('btn-right', () => moveRight = true, () => moveRight = false);
        document.getElementById('btn-drop').onclick = () => {
            if (state === 'idle') state = 'dropping';
        };

        function update() {
            if (!gameActive) return;

            // Gem Movement
            if (state !== 'caught') {
                gem.x += gem.speed * gem.direction;
                if (gem.x > canvas.width - 30 || gem.x < 30) gem.direction *= -1;
            }

            // Crane Logic
            if (state === 'idle') {
                if (moveLeft) craneX -= craneSpeed;
                if (moveRight) craneX += craneSpeed;
                craneX = Math.max(40, Math.min(canvas.width - 40, craneX));
            }

            if (state === 'dropping') {
                craneY += dropSpeed;
                obstacles.forEach(obs => {
                    if (craneX > obs.x && craneX < obs.x + obs.width &&
                        craneY > obs.y && craneY < obs.y + obs.height) {
                        state = 'lifting'; // Fail
                    }
                });
                const dist = Math.sqrt((craneX - gem.x) ** 2 + (craneY - gem.y) ** 2);
                if (dist < 40) {
                    state = 'caught';
                    clawOpen = false;
                    createParticles(gem.x, gem.y, '#00ffff', 20);
                    createFloatingMessage(gem.x, gem.y - 40, 'GET!!', '#00ffff');
                }
                if (craneY > canvas.height - 70) state = 'lifting';
            }

            if (state === 'caught') {
                craneY -= liftSpeed;
                gem.x = craneX;
                gem.y = craneY + 25;
                if (craneY <= 50) {
                    score++;
                    scoreDisplay.textContent = score;
                    level++;

                    createParticles(craneX, 50, '#fbbf24', 30);
                    createFloatingMessage(craneX, 100, 'BONUS TIME!!', '#fbbf24');

                    // Time Reset & Level Bonus: Level 2 -> 35s, Level 3 -> 40s
                    timeLeft = 30 + (level - 1) * 5;
                    timerDisplay.textContent = timeLeft;
                    timerDisplay.classList.remove('text-red-500');

                    // Success: Continue level without resetting timer interval
                    state = 'lifting';
                    clawOpen = true; // Open after dropping gem
                    setTimeout(() => {
                        state = 'idle';
                        craneY = 50;
                        initLevel();
                    }, 300);
                }
            }

            if (state === 'lifting') {
                craneY -= liftSpeed;
                clawOpen = true; // Always open while lifting without gem
                if (craneY <= 50) {
                    craneY = 50;
                    state = 'idle';
                }
            }

            // Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
            }

            // Floating Messages
            for (let i = floatingMessages.length - 1; i >= 0; i--) {
                const m = floatingMessages[i];
                m.y += m.vy;
                m.life -= 0.02;
                if (m.life <= 0) floatingMessages.splice(i, 1);
            }

            // Obstacles
            obstacles.forEach(obs => {
                obs.x += obs.speed;
                if (obs.x > canvas.width) obs.x = -obs.width;
                if (obs.x < -obs.width) obs.x = canvas.width;
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Gem
            ctx.font = gem.size + "px serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.shadowBlur = 15;
            ctx.shadowColor = "#00ffff";
            ctx.fillText("üíé", gem.x, gem.y);
            ctx.shadowBlur = 0;
            // Clouds
            ctx.font = "55px serif";
            obstacles.forEach(obs => {
                ctx.fillText("‚òÅÔ∏è", obs.x + obs.width / 2, obs.y + obs.height / 2);
            });
            // Line
            ctx.strokeStyle = "#ddd";
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(craneX, 0);
            ctx.lineTo(craneX, craneY);
            ctx.stroke();
            // Claw
            ctx.font = "65px serif";
            ctx.fillText(clawOpen ? "üñêÔ∏è" : "‚úä", craneX, craneY + 15);

            // Particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fill();
            });

            // Floating Messages
            floatingMessages.forEach(m => {
                ctx.globalAlpha = m.life;
                ctx.fillStyle = m.color;
                ctx.font = "bold 40px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText(m.text, m.x, m.y);
            });
            ctx.globalAlpha = 1.0;
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        gameLoop();

        function endGame(customMsg) {
            gameActive = false;
            clearInterval(timerInterval);
            timerInterval = null;
            gameUI.classList.add('hidden');
            playerInfoBadge.classList.add('hidden');
            document.getElementById('controls-panel').classList.add('hidden');
            players[currentPlayerIndex].score = score;
            turnResultScreen.classList.remove('hidden');
            document.getElementById('player-score-msg').textContent = `${players[currentPlayerIndex].name} „ÅØ ${score}„Åì „Ç≤„ÉÉ„Éà„Åó„ÅüÔºÅ`;
        }

        document.getElementById('next-player-btn').onclick = () => {
            currentPlayerIndex++;
            if (currentPlayerIndex < playerCount) showReadyScreen();
            else showFinalRanking();
        };

        function showFinalRanking() {
            turnResultScreen.classList.add('hidden');
            finalScreen.classList.remove('hidden');
            const sorted = [...players].sort((a, b) => b.score - a.score);
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';
            const medals = ['ü•á', 'ü•à', 'ü•â', '‚ú®'];
            sorted.forEach((p, i) => {
                const row = document.createElement('div');
                row.className = 'rank-card';
                row.innerHTML = `
                    <span class="text-xl font-bold text-white">${medals[i] || '‚ú®'} ${p.name}</span>
                    <span class="text-xl font-black text-yellow-400">${p.score}„Åì</span>
                `;
                list.appendChild(row);
            });
        }

        document.getElementById('restart-btn').onclick = () => {
            finalScreen.classList.add('hidden');
            modeScreen.classList.remove('hidden');
        };
    </script>
</body>

</html>